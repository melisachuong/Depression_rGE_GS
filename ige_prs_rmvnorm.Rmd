---
title: "Correlated direct-indirect genetic effects with transmitted/non-transmitted PRS simulations"
author: "Mark Adams"
output: html_notebook
---

```{r}
library(mvtnorm)
```

# Model

The variance component model we are simulating is:

\[
V_\mathrm{P} = V_\mathrm{A} + 2V_\mathrm{IGE} + V_\mathrm{E}
\]

where

- $V_\mathrm{P}$ is the phenotypic variance
- $V_\mathrm{A}$ is the direct genetic effect variance (additive genetic variance)
- $V_\mathrm{IGE}$ is the indirect genetic effect variance (effect of parents' genes via the environment on their offspring). The contribution of the variance is doubled because there is an effect from each parent
- $V_\mathrm{E}$ is the environment variance

and where $V_\mathrm{A}$ and $V_\mathrm{IGE}$ are correlated 

\[
\Sigma = \begin{bmatrix} V_\mathrm{A} & COV_\mathrm{A,IGE} \\
                  COV_\mathrm{A,IGE} & V_\mathrm{IGE}\end{bmatrix}
\]
       
# Parameters

Define the basic parameters for the simulation. 

```{r}
V_P = 1 # phenotypic variance
h2 = 0.5 # heritability (direct genetic effect proportion) (V_A/V_P)
ige2 = 0.1 # indirect genetic effect proportion (2*V_IGE/V_P)
s2 = 1 # proportion of V_A captured by polygenic scores
r_a_ige = 0.0 # genetic correlation between direct and indirect effect
n <- 1000000 # sample size (number of trios)
```

The remainder of the parameters can be defined from these.

Variance components:

```{r}
V_A <- h2*V_P # additive genetic variance
V_IGE <- ige2*V_P/2 # indirect genetic variance
V_PRS <- s2*V_A
```

which gives us

```{r}
V_A
2*V_IGE
V_PRS
```

We also need the covariance between $V_\mathrm{A}$ and $V_\mathrm{IGE}$, $COV_\mathrm{A,IGE}$. Since the correlation is $r_\mathrm{a,ige} = COV_\mathrm{A,IGE} / \sqrt{V_\mathrm{A} \times V_\mathrm{IGE}}$, then $COV_\mathrm{A,IGE} = r_\mathrm{a,ige} \times \sqrt{V_\mathrm{A}\times V_\mathrm{IGE}}$

```{r}
COV_A_IGE = r_a_ige * sqrt(V_A * V_IGE)
COV_A_IGE
```

PRS has a correlation of `r prs2` with the additive genetic variance and has a transmitted and non-transmitted component.

```{r}
V_T <- V_PRS/2
V_NT <- V_PRS/2
```

Transmitted and non-transmitted PRS will be uncorrelated with each other
```{r}
COV_T_NT <- 0
```

\[
\mathrm{cor}(T+NT, A) = \sqrt{\mathrm{s}^2}
\]

Expand the $\mathrm{cor}$ term

\[
\frac{\mathrm{cov}(T+NT, A)}{\sqrt{\mathrm{var}(T+NT)\mathrm{var}(A)}} = \mathrm{s}
\]

Substitute the sum of transmitted/non-transmitted variances
\[
\frac{\mathrm{cov}(T+NT, A)}{\sqrt{(\mathrm{var}(T)+\mathrm{var}(NT)-2\mathrm{cov}(T,NT))\mathrm{var}(A)}} = \mathrm{s}
\]

We established that $\mathrm{cov}(T,NT) = 0$
\[
\frac{\mathrm{cov}(T+NT, A)}{\sqrt{(\mathrm{var}(T)+\mathrm{var}(NT))\mathrm{var}(A)}} = \mathrm{s}
\]

\[
\mathrm{cov}(T+NT, A) = s \times \sqrt{(\mathrm{var}(T)+\mathrm{var}(NT))\mathrm{var}(A)}
\]

```{r}
COV_A_PRS <- sqrt(s2) * sqrt((V_T+V_NT)*V_A)
COV_A_PRS
COV_A_T <- COV_A_PRS/2
COV_A_NT <- COV_A_PRS/2
```

The covariance of the PRS with the indirect genetic effect:

```{r}
COV_T_IGE <- COV_A_T * COV_A_IGE
COV_NT_IGE <- COV_A_NT * COV_A_IGE
COV_T_IGE
COV_NT_IGE
```

The genetic effects variance-covariance matrix is a 4-by-4 matrix                 
                  
```{r}
genetic_effect_names <- c('direct', 'trans', 'nontrans', 'indirect')
Sigma = matrix(c(V_A,       COV_A_T,   COV_A_NT,   COV_A_IGE,
                 COV_A_T,   V_T,       COV_T_NT,   COV_T_IGE,
                 COV_A_NT,  COV_T_NT,  V_NT,       COV_NT_IGE,
                 COV_A_IGE, COV_T_IGE, COV_NT_IGE, V_IGE),
             nrow=4, ncol=4, byrow=T, dimnames=list(genetic_effect_names, genetic_effect_names))
Sigma
```

When determining the residual variance for the environment effect, the increase in variance from the covariance between the direct and indirect effects also needs to be subtracted. The variance of the sum of two variables is $\mathrm{var}(X+Y) = \mathrm{var}(X) + \mathrm{var}(Y) - 2\mathrm{cov}(X, Y)$. While there are two $V_\mathrm{IGE}$ components contributing (one from each parent) we only need to remove $2COV_\mathrm{A,IGE}$ because the covariance we defined above is that between a target's direct genetic effect on themselves and the indirect effect on the target's offspring but the contribution of this covariance to the phenotypic variance is between a target's direct genetic effect on the target's phenotype and the parents' (summed) indirect effect on the target's phenotype

```{r}
V_E = V_P - V_A - 2*V_IGE - 2*COV_A_IGE
V_E
```

# Simulation

For simulating data from the covariance matrix, the function `rmvnorm` is the multivariate equivalent of `rnorm`, parameterised by a vector of means and a covariance matrix `sigma`. Simulate genetic effects for mothers and fathers

```{r}
maternal_genetic <- data.frame(rmvnorm(n, sigma=Sigma))
paternal_genetic <- data.frame(rmvnorm(n, sigma=Sigma))
names(maternal_genetic) <- names(paternal_genetic) <- genetic_effect_names
```

This yields matrices of size $n \times 4$, so the first column is the direct effect, columns two and three are the transmitted and non-transmitted PRS effects, and the fourth column is the indirect genetic (nurture) effect.

```{r}
head(maternal_genetic)
```

Note that the indirect effects here are the genetic nurture effects on the phenotype of the offspring.

Simulate the other components of the parental phenotypes. Since we are simulating the grandparental indirect effect separately from the parental direct effects, we need to make up the missing variance by adding their covariance term into the residual (environmental )

```{r}
maternal_genetic_nurture <- rnorm(n, sd=sqrt(2*V_IGE)) # mother's parents' (combined) indirect effects (on the mother's phenotype)
paternal_genetic_nurture <- rnorm(n, sd=sqrt(2*V_IGE)) # father's parents' (combined) indirect effects (on the mother's phenotype)
maternal_environment <- rnorm(n, sd=sqrt(V_E+2*COV_A_IGE))
paternal_environment <- rnorm(n, sd=sqrt(V_E+2*COV_A_IGE))
```

Add up components to create parental phenotypes

```{r}
maternal_phenotype <- maternal_genetic$direct + maternal_genetic_nurture + maternal_environment
paternal_phenotype <- paternal_genetic$direct + paternal_genetic_nurture + paternal_environment
```

Check that the variances of the parental phenotpyes are as expected $\approx V_\mathrm{P}$ = `r V_P`.
```{r}
var(maternal_phenotype)
var(paternal_phenotype)
```

The transmitted and non-transmitted PRS add up to the total parental PRS
```{r}
maternal_prs <- maternal_genetic$trans + maternal_genetic$nontrans
paternal_prs <- paternal_genetic$trans + paternal_genetic$nontrans
```

Create offspring components

```{r}
offspring_genetic_inherited <- (maternal_genetic$direct + paternal_genetic$direct)/2  # average of parents
offspring_genetic_segregation <- rnorm(n, sd=sqrt(V_A/2)) # segregation variance is half of the additive genetic variance
offspring_genetic_direct <- offspring_genetic_inherited + offspring_genetic_segregation # effect of offspring's genes on their own phenotype
offspring_genetic_nurture <- maternal_genetic$indirect + paternal_genetic$indirect # indirect genetic effects of parents on offspring
offspring_environment <- rnorm(n=n, sd=sqrt(V_E))
offspring_phenotype <- offspring_genetic_direct + offspring_genetic_nurture + offspring_environment
offspring_prs <- (maternal_genetic$trans + paternal_genetic$trans)
```


```{r}
var(offspring_genetic_direct)
var(offspring_genetic_nurture)
var(offspring_environment)
var(offspring_phenotype)
var(offspring_prs)
```



